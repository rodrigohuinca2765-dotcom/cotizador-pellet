<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cotizador Pellet</title>
  <style>
    body{
      font-family: Arial, sans-serif;
      background:#f2f4f6;
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .card{
      width: 520px;
      max-width: 92vw;
      background:white;
      border-radius:12px;
      box-shadow:0 8px 24px rgba(0,0,0,.12);
      padding:26px 26px 20px 26px;
      text-align:center;
    }
    h1{
      margin:0 0 6px 0;
      color:#2e7d32;
      font-size:28px;
    }
    .hint{
      margin: 0 0 14px 0;
      color:#666;
      font-size:14px;
    }
    textarea{
      width:100%;
      height:90px;
      resize:none;
      border:1px solid #cfd8dc;
      border-radius:8px;
      padding:12px;
      font-size:15px;
      box-sizing:border-box;
    }
    button{
      width:100%;
      margin-top:12px;
      border:none;
      border-radius:8px;
      padding:12px;
      font-size:16px;
      cursor:pointer;
      background:#2e7d32;
      color:white;
      font-weight:bold;
    }
    button:disabled{
      opacity:.6;
      cursor:not-allowed;
    }
    .box{
      margin-top:14px;
      text-align:left;
      background:#f6f6f6;
      border-radius:8px;
      padding:12px;
      min-height:64px;
      white-space:pre-wrap;
      line-height:1.35;
    }
    .error{
      margin-top:10px;
      color:#c62828;
      font-weight:bold;
      text-align:center;
    }
    .wa{
      margin-top:12px;
      background:#25D366;
    }
    .muted{
      color:#666;
      font-size:13px;
    }
    .row{
      display:flex;
      gap:10px;
      margin-top:12px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>üî• Cotizador Pellet</h1>
    <p class="hint"><b>Ejemplo:</b> ‚ÄúNecesito 70 sacos de pellet para Coyhaique‚Äù</p>

    <textarea id="msg">Hola, quiero cotizar pellet</textarea>

    <div class="row">
      <button id="btn" onclick="enviar()">Cotizar (Agente)</button>
    </div>

    <div id="resp" class="box"><span class="muted">Escribe tu solicitud y presiona ‚ÄúCotizar (Agente)‚Äù.</span></div>

    <button id="btnWA" class="wa" style="display:none;" onclick="abrirWA()">üì≤ Enviar por WhatsApp</button>

    <div id="err" class="error"></div>
  </div>

<script>
  // ‚úÖ TU BACKEND EN RENDER:
  const API_BASE = "https://cotizador-pellet.onrender.com";

  // Historial b√°sico del chat (cliente/agente)
  let history = [];
  let lastWhatsappUrl = null;

  async function enviar(){
    const btn = document.getElementById("btn");
    const err = document.getElementById("err");
    const resp = document.getElementById("resp");
    const btnWA = document.getElementById("btnWA");

    err.textContent = "";
    btnWA.style.display = "none";
    lastWhatsappUrl = null;

    const mensaje = document.getElementById("msg").value.trim();
    if(!mensaje){
      err.textContent = "Escribe un mensaje para cotizar.";
      return;
    }

    btn.disabled = true;
    resp.textContent = "‚è≥ Esperando respuesta del agente‚Ä¶";

    // guardamos mensaje del usuario en historial
    history.push({ role: "user", content: mensaje });

    try{
      const r = await fetch(`${API_BASE}/chat`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ mensaje, history })
      });

      if(!r.ok){
        throw new Error("Respuesta no OK: " + r.status);
      }

      const data = await r.json();

      if(!data.ok){
        throw new Error("API respondi√≥ ok=false");
      }

      const agentReply = data.agent_reply || "No hubo respuesta.";
      resp.textContent = agentReply;

      // guardamos respuesta del agente en historial
      history.push({ role: "assistant", content: agentReply });

      // Si viene WhatsApp listo, mostramos bot√≥n
      if(data.ready_for_whatsapp && data.whatsapp_url){
        lastWhatsappUrl = data.whatsapp_url;
        btnWA.style.display = "block";
      }

    }catch(e){
      console.error(e);
      err.textContent = "Error al responder. Intente nuevamente.";
      resp.textContent = "";
    }finally{
      btn.disabled = false;
    }
  }

  function abrirWA(){
    if(!lastWhatsappUrl) return;
    window.open(lastWhatsappUrl, "_blank");
  }
</script>
</body>
</html>
